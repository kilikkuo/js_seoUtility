var fs=require("fs"),assert=require("assert"),os=require("os"),SEORule=require("./seorule"),_=require("underscore");function SEOUtility(){var results=[],htmlTagPlanarizedMap={},ready=!1,__objid=1,rawRules=[];function clearResults(){for(;results.length>0;)results.pop()}function prepareHTMLSource(source){assert(null!==source&&void 0!==source,"HTML Source should not be null or undefined");var treeAndMap=function(s){function extractTagName(ss){if(ss.startsWith("</")){var j=ss.indexOf(">");return ss.substring(2,j)}var splitted=(ss=ss.replace(">","")).split(" ")[0];return splitted.substring(1,splitted.length)}function generateChildNode(name,content,parent){var childNode={};return childNode.name=name,childNode.content=content,childNode.parent=parent,childNode.id=__objid,childNode.children=[],__objid+=1,childNode}var planeMap={};function addContentToPlaneMap(tag,childNode,parent){tag in planeMap||(planeMap[tag]=[]),planeMap[tag].push(childNode)}for(var tagContent,j,childNode,pointer=generateChildNode("root","",null),root=pointer,i=0;i<s.length;i++){var c=s.charAt(i);if("<"==c){j=s.indexOf(">",i+1);var name=extractTagName(tagContent=s.substring(i,j+1).toLowerCase()).toLowerCase();"/"==tagContent.charAt(tagContent.length-2)?(childNode=generateChildNode(name,tagContent,pointer),addContentToPlaneMap(name,childNode,pointer),pointer.children.push(childNode)):"/"!=tagContent.charAt(1)?(childNode=generateChildNode(name,tagContent,pointer),addContentToPlaneMap(name,childNode,pointer),pointer.children.push(childNode),pointer=childNode):null!=pointer.parent&&null!=pointer.parent.parent&&(pointer=pointer.parent),i=j}}return{tree:root,map:planeMap}}(source);treeAndMap.tree,htmlTagPlanarizedMap=treeAndMap.map,ready=!0}function isString(v){return"string"==typeof v||v instanceof String}function isRuleContained(rule){for(var i=0;i<rawRules.length;i++)if(_.isEqual(rawRules[i],rule))return!0;return!1}rawRules.push.apply(rawRules,SEORule.preDefinedRawRules);var self={setSourceFile:function(srcPath){return clearResults(),new Promise((resolve,reject)=>{fs.exists(srcPath,exists=>{exists?(prepareHTMLSource(fs.readFileSync(srcPath,"utf8")),resolve()):(console.log(`${srcPath} : no such file`),reject())})})},setSourceStream:function(srcStream){return assert(srcStream&&srcStream.readable,"Source stream should be readable."),clearResults(),new Promise((resolve,reject)=>{var chunks=[];srcStream.on("readable",()=>{var chunk=srcStream.read();chunk&&chunks.push(chunk.toString())}),srcStream.on("data",chunk=>{chunks.push(chunk.toString())}),srcStream.on("end",()=>{prepareHTMLSource(chunks.join("")),resolve()}),srcStream.on("error",()=>{console.log("srcStream event: error"),reject()})})},findAllMatches:function(tag){return assert(ready,"Should NOT be called when it's not ready"),tag in htmlTagPlanarizedMap?htmlTagPlanarizedMap[tag]:[]},getCurrentSEORuleIndices:function(){for(var r in console.log("=== Current SEO Rules ==="),rawRules){var msg=SEORule.translateRuleToMsg(rawRules[r]);console.log(`Rule Index : ${r} => ${msg}`)}return console.log("========================="),[...Array(rawRules.length).keys()]},addRuleCheckTagWithAttr:function(tag,attr){if(isString(tag)&&isString(attr)&&""!==tag&&""!==attr){var rule=SEORule.createRawRuleByTagAttr(tag,attr);if(!isRuleContained(rule))return rawRules.push(rule),!0}return!1},addRuleCheckTagWithChildTag:function(tag,childTag){if(isString(tag)&&isString(childTag)&&""!==tag&&""!==childTag){var rule=SEORule.createRawRuleByTagChildTag(tag,childTag);if(!isRuleContained(rule))return rawRules.push(rule),!0}return!1},addRuleCheckTagWithChildTagAttrVal:function(tag,childTag,childAttr,childVal){if(isString(tag)&&isString(childTag)&&isString(childAttr)&&isString(childAttr)&&""!==tag&&""!==childTag&&""!==childAttr&&""!==childVal){var rule=SEORule.createRawRuleByTagChildTagAttrVal(tag,childTag,childAttr,childVal);if(!isRuleContained(rule))return rawRules.push(rule),!0}return!1},addRuleCheckTagAmount:function(tag,amount){if(isString(tag)&&("number"==typeof(v=amount)||v instanceof Number)&&""!==tag&&amount>=0){var rule=SEORule.createRawRuleByTagAmount(tag,amount);if(!isRuleContained(rule))return rawRules.push(rule),!0}var v;return!1},evaluteSEORules:function(ruleIndices=[0,1,2,3,4,5,6]){return clearResults(),new Promise((resolve,reject)=>{var selectedRawRules=[],selectedIndices=[];for(var idx of ruleIndices)selectedRawRules.push(rawRules[idx]),selectedIndices.push(idx);console.log(`Selected SEORule indices : ${selectedIndices}`);var preparedRules=function(seletecRawRules){var seoRules=[];for(let rawRule of seletecRawRules){var rule=SEORule.createSEORulesByType(self,rawRule);seoRules.push(rule)}return seoRules}(selectedRawRules);for(var rule of(console.log("Evaluating ..."),preparedRules)){var result=rule.evalutate();results.push(result)}resolve()})},outputConsole:function(){return new Promise((resolve,reject)=>{for(var r of(console.log("=== Results ==="),results))console.log(r);console.log("==============="),resolve()})},outputFile:function(destPath){return new Promise((resolve,reject)=>{fs.open(destPath,"w",(err,fd)=>{if(err)return console.error(err),void reject();for(var r of results)fs.appendFileSync(destPath,r),fs.appendFileSync(destPath,os.EOL);fs.closeSync(fd),resolve()})})},outputStream:function(destPath){return new Promise((resolve,reject)=>{var wstream=fs.createWriteStream(destPath);for(var r of results)wstream.write(r),wstream.write(os.EOL);wstream.end(),resolve(wstream)})},isReadyToEvalute:function(){return ready},getCurrentRawRules:function(){return rawRules.slice()}};return self}module.exports={SEOUtility,PreDefinedRawRules:SEORule.preDefinedRawRules};